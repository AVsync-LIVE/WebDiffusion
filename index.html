<!DOCTYPE html>
<html>
<head>
    <title>WebDiffusion</title>
    <meta property="og:title" content="WebDiffusion">
    <meta property="og:description" content="Create images in your browser with Stable Diffusion - secure, free, and no installation required.">
    <meta property="og:image" content="img/webdiffusion-social-share.png">
    <link rel="stylesheet" type="text/css" href="/assets/css/index.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#121212">
</head>
<body>
    <script src="dist/tvmjs_runtime.wasi.js"></script>
    <script src="dist/tvmjs.bundle.js"></script>

    <div class="container">
        <div class="input-column">
            <span>
                <img id='logo' src="img/webdiffusion-typography.svg" alt="WebDiffusion"/>
            </span>
            <p>Create images in your browser with Stable Diffusion - secure, free, and no installation required.</p>
            <p>Please ensure you have a GPU with 8GB VRAM (or an M1/M2 Mac), and Chrome or Edge version 113 or higher.</p>
            <label for="inputPrompt">Prompt</label>
            <textarea name="inputPrompt" id="inputPrompt">radial organic reaction diffusion icon svg black and white thick</textarea>

            <label for="negativePrompt">Negative Prompt</label>
            <textarea name="negativePrompt" id="negativePrompt"  value=""></textarea>
            <button onclick="tvmjsGlobalEnv.asyncOnGenerate()" id="generate">Generate</button>
        </div>

        <div class="output-column">
            <canvas id="canvas" width="512" height="512"></canvas>
            <button type="button" onClick="downloadCanvas()">Download</button>
            <div id="log"></div>
        </div>
    </div>

    <script>
        var tvmjsGlobalEnv = tvmjsGlobalEnv || {};

        function downloadCanvas() {
            const canvas = document.getElementById("canvas");
            const prompt = document.getElementById("inputPrompt").value.trim();
            const filename = prompt ? prompt + ".png" : "webdiffusion.png";

            const downloadLink = document.createElement("a");
            downloadLink.href = canvas.toDataURL("image/png");
            downloadLink.download = filename;
            downloadLink.click();
        }
    </script>

    <script type="module">
        import init, { TokenizerWasm } from "./dist/tokenizers-wasm/tokenizers_wasm.js";

        var initialized = false;
        async function getTokenizer(name) {
            if (!initialized) {
                await init();
            }
            const jsonText = await (await fetch("https://huggingface.co/" + name + "/raw/main/tokenizer.json")).text();
            return new TokenizerWasm(jsonText);
        }

        tvmjsGlobalEnv.getTokenizer = getTokenizer;
    </script>

    <script src="dist/stable_diffusion.js"></script>

    <script>
        document.getElementById("log").innerHTML = `
            <label id="gpu-tracker-label">Note: A ~2GB model will be downloaded the first time you generate.</label><br />
            <label id="progress-tracker-label"></label><br />
            <progress id="progress-tracker-progress" max="100" value="0"></progress>
        `;
    </script>
     <script>
        // Check to make sure the browser supports service workers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .register('/service-worker.js')
          .then(() => {
            console.log('Service worker registered');
          })
          .catch(err => {
            console.log('Service worker registration failed: ' + err);
          });
      }
      </script>
</body>
</html>
